generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// USER & AUTH
// ─────────────────────────────────────────────

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  passwordHash String
  role         String   // GOV | HOSPITAL | CITIZEN
  name         String?
  wardId       String?
  fcmToken     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  citizenReports CitizenReport[]

  @@index([role])
  @@index([wardId])
}

// ─────────────────────────────────────────────
// WARD (Geographic Unit)
// ─────────────────────────────────────────────

model Ward {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  city       String
  state      String
  latitude   Float
  longitude  Float
  population Int?

  hospitalAdmissions HospitalAdmission[]
  waterReports       WaterQualityReport[]
  weatherData        WeatherData[]
  citizenReports     CitizenReport[]
  riskPredictions    RiskPrediction[]
  alerts             Alert[]

  @@index([city])
}

// ─────────────────────────────────────────────
// SYNDROME MAPPING (Lookup Table)
// ─────────────────────────────────────────────

model SyndromeMapping {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  syndromeType     String  // DIARRHEA | FEVER | VOMITING | COUGH | RESPIRATORY_DISTRESS | SKIN_RASH | JAUNDICE | HEADACHE | UNKNOWN
  outbreakCategory String  // WATERBORNE | FOODBORNE | AIRBORNE | VECTOR_BORNE | HOSPITAL_ACQUIRED | UNKNOWN
  weight           Float   @default(1.0)
  description      String?

  @@unique([syndromeType, outbreakCategory])
}

// ─────────────────────────────────────────────
// HOSPITAL ADMISSIONS
// ─────────────────────────────────────────────

model HospitalAdmission {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  wardId           String   @db.ObjectId
  ward             Ward     @relation(fields: [wardId], references: [id])
  hospitalName     String
  reportDate       DateTime
  syndromeType     String   // SyndromeType enum value
  outbreakCategory String   // OutbreakCategory enum value
  admissionCount   Int
  severeCount      Int      @default(0)
  deathCount       Int      @default(0)
  ageGroup         String?
  createdAt        DateTime @default(now())

  @@index([wardId])
  @@index([syndromeType])
  @@index([reportDate])
}

// ─────────────────────────────────────────────
// WATER QUALITY
// ─────────────────────────────────────────────

model WaterQualityReport {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  wardId         String   @db.ObjectId
  ward           Ward     @relation(fields: [wardId], references: [id])
  reportDate     DateTime
  chlorineLevel  Float
  phLevel        Float
  turbidity      Float
  ecoli          Float?
  totalColiforms Float?
  source         String?
  createdAt      DateTime @default(now())

  @@index([wardId])
  @@index([reportDate])
}

// ─────────────────────────────────────────────
// WEATHER DATA
// ─────────────────────────────────────────────

model WeatherData {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  wardId      String   @db.ObjectId
  ward        Ward     @relation(fields: [wardId], references: [id])
  recordedAt  DateTime
  rainfall    Float
  temperature Float
  humidity    Float
  windSpeed   Float?
  uvIndex     Float?
  createdAt   DateTime @default(now())

  @@index([wardId])
  @@index([recordedAt])
}

// ─────────────────────────────────────────────
// CITIZEN REPORTS
// ─────────────────────────────────────────────

model CitizenReport {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String?  @db.ObjectId
  user         User?    @relation(fields: [userId], references: [id])
  wardId       String   @db.ObjectId
  ward         Ward     @relation(fields: [wardId], references: [id])
  latitude     Float
  longitude    Float
  syndromeType String
  description  String?
  severity     Int      @default(1)
  reportedAt   DateTime @default(now())
  isVerified   Boolean  @default(false)

  @@index([wardId])
  @@index([syndromeType])
}

// ─────────────────────────────────────────────
// RISK PREDICTIONS (ML Output)
// ─────────────────────────────────────────────

model RiskPrediction {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  wardId           String   @db.ObjectId
  ward             Ward     @relation(fields: [wardId], references: [id])
  predictedAt      DateTime @default(now())
  forecastHorizon  Int      @default(48)
  riskScore        Float
  outbreakCategory String
  confidence       Float
  isAnomaly        Boolean  @default(false)
  shapReasons      String   @default("[]")
  outbreakReasons  String   @default("[]")
  rawFeatures      String?

  alerts Alert[]

  @@index([wardId])
  @@index([riskScore])
}

// ─────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────

model Alert {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  wardId            String   @db.ObjectId
  ward              Ward     @relation(fields: [wardId], references: [id])
  predictionId      String?  @db.ObjectId
  prediction        RiskPrediction? @relation(fields: [predictionId], references: [id])
  severity          String   // LOW | MEDIUM | HIGH | CRITICAL
  outbreakCategory  String
  message           String
  recommendedAction String?
  recipientType     String   // GOV | HOSPITAL | CITIZEN | ALL
  status            String   @default("PENDING") // PENDING | SENT | FAILED
  sentAt            DateTime?
  createdAt         DateTime @default(now())

  @@index([wardId])
  @@index([severity])
  @@index([status])
}
